name: 现场构建OpenD

on: workflow_dispatch

jobs:
  build-and-pack:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: 1. 准备环境 & 下载 Python
        run: |
          echo ">>> 正在下载 Python 基础镜像..."
          docker pull python:3.9-slim
          docker save -o python-brain.tar python:3.9-slim

      - name: 2. 现场构建 OpenD (Build)
        run: |
          echo ">>> 正在拉取 OpenD 源代码..."
          # 克隆目前可用的源码仓库
          git clone https://github.com/manhinhang/futu-opend-docker.git source_code
          
          echo ">>> 正在构建镜像 (这可能需要 2-3 分钟)..."
          cd source_code
          # 使用源码构建一个新镜像，名字叫 futu-final:latest
          docker build -t futu-final:latest .
          
          # 验证构建是否成功
          echo ">>> 验证构建结果..."
          docker images | grep futu-final

      - name: 3. 打包构建好的镜像
        run: |
          echo ">>> 正在将构建好的镜像打包为文件..."
          # 将刚才构建的 futu-final:latest 保存为 tar 文件
          docker save -o futu-opend.tar futu-final:latest

      - name: 4. 上传结果到网页
        uses: actions/upload-artifact@v4
        with:
          name: nas-docker-files
          path: "*.tar"
          retention-days: 1
