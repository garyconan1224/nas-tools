name: 修复版三保险下载

on: workflow_dispatch

jobs:
  download-job:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 执行下载任务 (三合一脚本)
        run: |
          # =======================================================
          # 第一部分：下载 Python (这个肯定没问题)
          # =======================================================
          echo ">>> 正在下载 Python..."
          docker pull python:3.9-slim
          echo ">>> Python 打包中..."
          docker save -o python-brain.tar python:3.9-slim

          # =======================================================
          # 第二部分：下载 OpenD (三保险逻辑)
          # =======================================================
          echo ">>> 正在尝试下载 OpenD..."
          
          # 尝试 A: ghostry (老牌镜像)
          if docker pull ghostry/futu-opend:latest; then
            echo "✅ 方案A (ghostry) 下载成功！"
            docker tag ghostry/futu-opend:latest futu-final:latest

          # 尝试 B: titwdj (备用镜像)
          elif docker pull titwdj/futu-opend:latest; then
            echo "✅ 方案B (titwdj) 下载成功！"
            docker tag titwdj/futu-opend:latest futu-final:latest

          # 尝试 C: garyli1019 (备用镜像)
          elif docker pull garyli1019/futu-opend:latest; then
            echo "✅ 方案C (garyli1019) 下载成功！"
            docker tag garyli1019/futu-opend:latest futu-final:latest

          else
            echo "❌ 警告：OpenD 所有镜像源都下载失败。"
          fi

          # =======================================================
          # 第三部分：打包 OpenD (如果下载成功的话)
          # =======================================================
          if docker image inspect futu-final:latest > /dev/null 2>&1; then
            echo ">>> 正在打包 OpenD..."
            docker save -o futu-opend.tar futu-final:latest
          else
            echo ">>> 跳过 OpenD 打包 (因为下载失败)"
          fi

      - name: 2. 上传文件到网页
        uses: actions/upload-artifact@v4
        with:
          name: nas-docker-files
          path: "*.tar"
          retention-days: 1
